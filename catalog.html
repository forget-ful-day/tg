
from flask import Flask, jsonify, request, send_from_directory
from flask_cors import CORS
import json
import os
from datetime import datetime
import uuid

app = Flask(__name__, static_folder='.')
CORS(app)

# –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
DATA_FILE = 'catalog_data.json'

def load_data():
    """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞"""
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {
        'catalog': {},
        'carts': {},
        'orders': {}
    }

def save_data(data):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª"""
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

@app.route('/')
def serve_index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    return send_from_directory('.', 'catalog.html')

@app.route('/api/catalog')
def get_catalog():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤"""
    data = load_data()
    return jsonify(data.get('catalog', {}))

@app.route('/api/cart/<user_id>')
def get_cart(user_id):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    data = load_data()
    cart = data.get('carts', {}).get(user_id, {})
    return jsonify(cart)

@app.route('/api/cart/<user_id>', methods=['POST'])
def update_cart(user_id):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    data = load_data()
    cart_data = request.json
    
    if 'carts' not in data:
        data['carts'] = {}
    
    if user_id not in data['carts']:
        data['carts'][user_id] = {}
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É
    for item_id, quantity in cart_data.items():
        if quantity > 0:
            data['carts'][user_id][item_id] = quantity
        elif item_id in data['carts'][user_id]:
            del data['carts'][user_id][item_id]
    
    save_data(data)
    return jsonify({'success': True, 'cart': data['carts'][user_id]})

@app.route('/api/order', methods=['POST'])
def create_order():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞"""
    order_data = request.json
    user_id = order_data.get('user_id')
    
    if not user_id:
        return jsonify({'success': False, 'error': 'User ID is required'}), 400
    
    data = load_data()
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cart = data.get('carts', {}).get(user_id, {})
    if not cart:
        return jsonify({'success': False, 'error': 'Cart is empty'}), 400
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∑–∞–∫–∞–∑–∞
    order_id = str(uuid.uuid4())[:8].upper()
    
    # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ
    order_items = []
    total_amount = 0
    
    for item_id, quantity in cart.items():
        # –ù–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
        item_info = None
        for category in data.get('catalog', {}).values():
            if 'items' in category and item_id in category['items']:
                item_info = category['items'][item_id]
                break
        
        if item_info:
            item_total = item_info.get('price', 0) * quantity
            total_amount += item_total
            order_items.append({
                'id': item_id,
                'name': item_info.get('name', '–¢–æ–≤–∞—Ä'),
                'quantity': quantity,
                'price': item_info.get('price', 0),
                'total': item_total
            })
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
    order = {
        'id': order_id,
        'user_id': user_id,
        'date': datetime.now().isoformat(),
        'items': order_items,
        'total': total_amount,
        'status': 'pending'
    }
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑
    if 'orders' not in data:
        data['orders'] = {}
    
    if user_id not in data['orders']:
        data['orders'][user_id] = []
    
    data['orders'][user_id].append(order)
    
    # –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
    if user_id in data['carts']:
        data['carts'][user_id] = {}
    
    save_data(data)
    
    return jsonify({
        'success': True,
        'order_id': order_id,
        'order': order
    })

@app.route('/api/orders/<user_id>')
def get_orders(user_id):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    data = load_data()
    orders = data.get('orders', {}).get(user_id, [])
    return jsonify(orders)

@app.route('/api/init_data')
def init_data():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–µ–º–æ"""
    demo_catalog = {
        'electronics': {
            'id': 'electronics',
            'name': '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞',
            'icon': 'üì±',
            'description': '–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã, –Ω–æ—É—Ç–±—É–∫–∏, –≥–∞–¥–∂–µ—Ç—ã',
            'items': {
                'smartphone': {
                    'id': 'smartphone',
                    'name': 'iPhone 15 Pro',
                    'description': '–§–ª–∞–≥–º–∞–Ω—Å–∫–∏–π —Å–º–∞—Ä—Ç—Ñ–æ–Ω Apple —Å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º A17 Pro',
                    'price': 99999,
                    'currency': 'RUB',
                    'specs': {
                        '–≠–∫—Ä–∞–Ω': '6.1" Super Retina XDR',
                        '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä': 'A17 Pro',
                        '–ü–∞–º—è—Ç—å': '256 –ì–ë',
                        '–ö–∞–º–µ—Ä–∞': '48 –ú–ø'
                    }
                },
                'laptop': {
                    'id': 'laptop',
                    'name': 'MacBook Air M3',
                    'description': '–£–ª—å—Ç—Ä–∞—Ç–æ–Ω–∫–∏–π –Ω–æ—É—Ç–±—É–∫ —Å —á–∏–ø–æ–º Apple M3',
                    'price': 129999,
                    'currency': 'RUB',
                    'specs': {
                        '–≠–∫—Ä–∞–Ω': '13.6" Liquid Retina',
                        '–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä': 'Apple M3',
                        '–ü–∞–º—è—Ç—å': '512 –ì–ë',
                        '–í–µ—Å': '1.24 –∫–≥'
                    }
                }
            }
        },
        'clothing': {
            'id': 'clothing',
            'name': '–û–¥–µ–∂–¥–∞',
            'icon': 'üëï',
            'description': '–ú–æ–¥–Ω–∞—è –æ–¥–µ–∂–¥–∞ –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã',
            'items': {
                'tshirt': {
                    'id': 'tshirt',
                    'name': '–§—É—Ç–±–æ–ª–∫–∞ Premium',
                    'description': '–•–ª–æ–ø–∫–æ–≤–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞ –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞',
                    'price': 1999,
                    'currency': 'RUB',
                    'specs': {
                        '–ú–∞—Ç–µ—Ä–∏–∞–ª': '100% —Ö–ª–æ–ø–æ–∫',
                        '–†–∞–∑–º–µ—Ä—ã': 'XS-XXL',
                        '–¶–≤–µ—Ç–∞': '–ß–µ—Ä–Ω—ã–π, –ë–µ–ª—ã–π, –°–µ—Ä—ã–π'
                    }
                }
            }
        }
    }
    
    data = load_data()
    data['catalog'] = demo_catalog
    save_data(data)
    
    return jsonify({'success': True, 'message': 'Demo data initialized'})

if __name__ == '__main__':
    print("üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:5000")
    print("üì± –î–ª—è Mini App –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL: https://–≤–∞—à-–¥–æ–º–µ–Ω/catalog.html")
    app.run(host='0.0.0.0', port=5000, debug=True)
